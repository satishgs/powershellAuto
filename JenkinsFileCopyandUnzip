pipeline {
    agent { label 'windows10' }

    environment {
        SOURCE_PATH = null
        DEST_PATH = null
        UNPACK_PATH = null
    }

    stages {
        stage('Copy Zip') {
            steps {
                script {
                    powershell '''
                    Write-Host "Starting the script to copy the zip file..."

                    # Prompt user for paths if not set as environment variables
                    if ([string]::IsNullOrWhiteSpace($Env:SOURCE_PATH)) {
                        $Env:SOURCE_PATH = Read-Host -Prompt "Please enter the source file path"
                    }
                    if ([string]::IsNullOrWhiteSpace($Env:DEST_PATH)) {
                        $Env:DEST_PATH = Read-Host -Prompt "Please enter the destination file path"
                    }
                    if ([string]::IsNullOrWhiteSpace($Env:UNPACK_PATH)) {
                        $Env:UNPACK_PATH = Read-Host -Prompt "Please enter the path to unpack files"
                    }

                    # Validate source file path
                    if (!(Test-Path -Path $Env:SOURCE_PATH -IsValid)) {
                        Write-Error "ERROR: The source file path is invalid or inaccessible. Please verify the path and try again."
                        exit 1
                    }

                    # Validate destination directory path
                    $destinationDir = Split-Path -Path $Env:DEST_PATH -Parent
                    if (!(Test-Path -Path $destinationDir -IsValid)) {
                        Write-Error "ERROR: The destination directory path is invalid or inaccessible. Please verify the path and try again."
                        exit 1
                    }

                    # Delete the destination file if it exists
                    if (Test-Path -Path $Env:DEST_PATH -IsValid) {
                        Write-Host "The destination file at $Env:DEST_PATH already exists. Deleting the existing file..."
                        Remove-Item -Path $Env:DEST_PATH -Force
                    }

                    Write-Host "Starting the file copy from $Env:SOURCE_PATH to $Env:DEST_PATH. This may take some time for large files..."

                    # Begin copying file using robocopy for speed
                    $job = Start-Job -ScriptBlock {
                        robocopy (Split-Path -Path $Env:SOURCE_PATH) $destinationDir (Split-Path -Path $Env:SOURCE_PATH -Leaf) /R:3 /W:5 /NP /TEE /ETA /MT /LOG+:$Env:WORKSPACE\robocopy.log /FP /XO /XC /XN /NS /NJH /NJS /NFL /NDL
                    }

                    while ($job.State -eq 'Running') {
                        $job | Receive-Job -Wait | ForEach-Object {
                            $percentage = $_.Split('%')[0].Trim()
                            Write-Progress -Activity "Copying file" -PercentComplete $percentage
                        }
                    }

                    if ($job.State -eq 'Failed') {
                        Write-Error "File copy failed."
                        $job | Receive-Job -Wait
                        exit 1
                    }

                    Write-Host "File copy completed successfully."
                    '''
                }
            }
        }

        stage('Unpack Zip') {
            steps {
                script {
                    powershell '''
                    Write-Host "Starting the zip file unpacking process. This may take some time for large zip files..."

                    # Validate zip file path
                    if (!(Test-Path -Path $Env:DEST_PATH -IsValid)) {
                        Write-Error "ERROR: The zip file path is invalid or inaccessible. Please verify the path and try again."
                        exit 1
                    }

                    # Validate unpack directory path
                    if (!(Test-Path -Path $Env:UNPACK_PATH -IsValid)) {
                        Write-Error "ERROR: The unpack directory path is invalid or inaccessible. Please verify the path and try again."
                        exit 1
                    }

                    # Use System.IO.Compression.FileSystem class from .NET to extract the zip for better performance
                    Add-Type -Assembly "System.IO.Compression.FileSystem"
                    $zipFile = [System.IO.Compression.ZipFile]::OpenRead($Env:DEST_PATH)
                    $totalCount = $zipFile.Entries.Count
                    $index = 0

                    foreach ($entry in $zipFile.Entries) {
                        $index++
                        $progressPercentage = ($index / $totalCount) * 100
                        Write-Progress -Activity "Unpacking zip file" -PercentComplete $progressPercentage

                        $entry.ExtractToFile("$Env:UNPACK_PATH\$($entry.FullName)", $true)
                    }

                    $zipFile.Dispose()

                    Write-Host "Zip file unpacked successfully."
                    '''
                }
            }
        }
    }
}
